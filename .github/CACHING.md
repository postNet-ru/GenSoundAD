# Оптимизация кеширования в GitHub Actions

## Обзор

Проект Ring Generator использует несколько уровней кеширования для ускорения CI/CD процессов:

## Типы кеширования

### 1. Зависимости Node.js
```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '18'
    cache: 'npm'
    cache-dependency-path: 'package-lock.json'
```

**Что кешируется:** 
- `node_modules/`
- npm cache

**Ключ кеша:** Основан на `package-lock.json`

### 2. Rust и Cargo зависимости
```yaml
- name: Cache Rust dependencies
  uses: actions/cache@v4
  with:
    path: |
      ~/.cargo/bin/
      ~/.cargo/registry/index/
      ~/.cargo/registry/cache/
      ~/.cargo/git/db/
      src-tauri/target/
    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    restore-keys: |
      ${{ runner.os }}-cargo-
```

**Что кешируется:**
- Скомпилированные Rust зависимости
- Cargo registry
- Промежуточные артефакты сборки

**Ключ кеша:** Основан на `Cargo.lock`

### 3. FFmpeg бинарные файлы
```yaml
- name: Cache FFmpeg binaries
  uses: actions/cache@v4
  with:
    path: src-tauri/binaries/
    key: ffmpeg-binaries-${{ runner.os }}-v1
    restore-keys: |
      ffmpeg-binaries-${{ runner.os }}-
```

**Что кешируется:**
- Скачанные FFmpeg бинарники для всех платформ

**Ключ кеша:** Основан на операционной системе

### 4. Системные зависимости (Ubuntu)
```yaml
- name: Cache system dependencies (Ubuntu)
  if: matrix.platform == 'ubuntu-latest'
  uses: actions/cache@v4
  with:
    path: /var/cache/apt
    key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/release.yml') }}
    restore-keys: |
      ${{ runner.os }}-apt-
```

**Что кешируется:**
- Кеш пакетного менеджера apt

**Ключ кеша:** Основан на содержимом workflow файла

## Файлы workflow

### release.yml
- **Назначение:** Создание релизных сборок
- **Оптимизации:** Полное кеширование всех зависимостей
- **Время экономии:** ~10-15 минут на сборку

### ci.yml
- **Назначение:** Непрерывная интеграция (тестирование)
- **Оптимизации:** Быстрые проверки без создания бинарников
- **Время экономии:** ~5-8 минут на проверку

### dev.yml
- **Назначение:** Разработческие сборки
- **Оптимизации:** Debug сборки с максимальным переиспользованием кеша
- **Время экономии:** ~8-12 минут на сборку

## Эффект от кеширования

### Без кеширования:
- **Первая сборка:** ~25-30 минут
- **Повторная сборка:** ~25-30 минут

### С кешированием:
- **Первая сборка:** ~25-30 минут
- **Повторная сборка:** ~8-12 минут
- **Экономия времени:** 60-75%

## Стратегии инвалидации кеша

1. **Cargo зависимости:** Обновляются при изменении `Cargo.lock`
2. **Node зависимости:** Обновляются при изменении `package-lock.json`
3. **FFmpeg:** Ручная инвалидация через изменение версии в ключе
4. **Системные пакеты:** Обновляются при изменении workflow файлов

## Мониторинг кеша

GitHub Actions предоставляет статистику использования кеша:
- Размер каждого кеша
- Частота попаданий/промахов
- Время создания и последнего использования

## Рекомендации

1. **Регулярно проверяйте** размеры кешей (лимит 10GB на репозиторий)
2. **Очищайте старые кеши** если они не используются >7 дней
3. **Используйте restore-keys** для частичного попадания в кеш
4. **Версионируйте ключи кеша** при критических изменениях

## Очистка кеша

При необходимости принудительной очистки кеша:

1. Измените версию в ключе кеша (`v1` → `v2`)
2. Или удалите кеши через GitHub UI:
   - Settings → Actions → Caches → Удалить нужные кеши

## Troubleshooting

### Проблема: Сборка занимает слишком много времени
**Решение:** Проверьте логи на предмет "cache hit/miss", убедитесь что кеши используются

### Проблема: Ошибки компиляции после изменений
**Решение:** Очистите Rust кеш, изменив версию ключа

### Проблема: Превышен лимит размера кеша
**Решение:** Удалите старые кеши или уменьшите количество кешируемых путей
